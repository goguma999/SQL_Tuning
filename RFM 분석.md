# [DA] RFM ë¶„ì„

### ğŸ“RFM

- ê³ ê° ë¶„ë¥˜ ê¸°ë²• ì¤‘ í•˜ë‚˜ë¡œ CRM ë§ˆì¼€íŒ…ì—ì„œ ê³ ê° íƒ€ê²ŸíŒ…ìœ¼ë¡œ ì£¼ë¡œ í™œìš©
- **R ecency** ì–¼ë§ˆë‚˜ ìµœê·¼ì— êµ¬ë§¤í–ˆëŠ”ê°€
- **F requency** ì–¼ë§ˆë‚˜ ìì£¼ êµ¬ë§¤í–ˆëŠ”ê°€
- **M onetary** ì–¼ë§Œí¼ì˜ ê·œëª¨ë¡œ êµ¬ë§¤í–ˆëŠ”ê°€

| ì‚¬ìš©ì | ìµœê·¼ êµ¬ë§¤ì¼ | ìµœê·¼ 1ë‹¬ ê°„ êµ¬ë§¤íšŸìˆ˜ |  ìµœê·¼ 1ë‹¬ ê°„ êµ¬ë§¤ê¸ˆì•¡ |
| --- | --- | --- | --- |
| A | 2ì£¼ ì „ | 8íšŒ | 220,000 |
| B | ì–´ì œ | 2íšŒ | 180,000 |

ì‚¬ìš©ìë³„ë¡œ RFM ì ìˆ˜ë¥¼ ì‚°ì¶œí•´ì„œ ë°±ë¶„ìœ„ìˆ˜ ê°œë…ìœ¼ë¡œ ê·¸ë£¹ìœ¼ë¡œ ë¶„ë¥˜í•˜ê³ , ì–´ë–¤ ê·¸ë£¹ì´ ì´íƒˆ ê°€ëŠ¥ì„±ì´ ë†’ì„ì§€ ì•Œì•„ë³´ì.

### ğŸ“ë°±ë¶„ìœ„ìˆ˜(percentile)

- **ì „ì²´ë¥¼ 100ìœ¼ë¡œ ë³´ê³  ì‘ì€ ê²ƒë¶€í„°(0) í° ê²ƒê¹Œì§€(100) ì°¨ë¡€ë¡œ ë‚˜ì—´í–ˆì„ ë•Œ Në²ˆì§¸ ì˜¤ëŠ” ìˆ˜**ë¥¼ ì˜ë¯¸
- ex
    - ì˜ì–´ 90ì  (ë°±ë¶„ìœ„ìˆ˜ 70)
    - ìˆ˜í•™ 80ì  (ë°±ë¶„ìœ„ìˆ˜ 95)
- íŒŒì´ì¬ìœ¼ë¡œ ë°±ë¶„ìœ„ìˆ˜ êµ¬í•˜ê¸°
    - `Numpy` í•¨ìˆ˜
    - `percentil(ê°’, [20,40,60])`

### ğŸ“ë…ë¦½ë³€ìˆ˜ì™€ ì¢…ì†ë³€ìˆ˜ì˜ ìƒê´€ê´€ê³„

- RFM ì ìˆ˜ë¥¼ ì‚°ì¶œí•  ë•Œ íšŒê·€ê³„ìˆ˜ë¥¼ êµ¬í•´ì„œ ê° ë³€ìˆ˜ì— ê³±í•´ì¤˜ì•¼ í•¨
- **ì„ í˜•íšŒê·€** ?
    - ì¢…ì†ë³€ìˆ˜ê°€ **ì—°ì†í˜•**ìœ¼ë¡œ ë…ë¦½ë³€ìˆ˜ì™€ ì¢…ì†ë³€ìˆ˜ê°€ ì„ í˜•ê´€ê³„
    - íšŒê·€ê³„ìˆ˜ = ë…ë¦½ë³€ìˆ˜ì™€ ì¢…ì†ë³€ìˆ˜ê°€ ì–¼ë§ˆë‚˜ ê°•í•œ ìƒê´€ê´€ê³„ë¥¼ ê°–ëŠ”ì§€ë¥¼ ë³´ì—¬ì¤Œ = ê¸°ìš¸ê¸°
    - ì´íƒˆìœ¨, ì£¼ë¬¸ì „í™˜ìœ¨ ë“±
- **ë¡œì§€ìŠ¤í‹± íšŒê·€** ? ì¢…ì†ë³€ìˆ˜ê°€ ë²”ì£¼í˜•ìœ¼ë¡œ **binary(0ê³¼ 1)**ë¡œ í‘œí˜„ ê°€ëŠ¥í•œ ë°ì´í„°
    - ì„±ê³µ/ì‹¤íŒ¨, í•©ê²©/ë¶ˆí•©ê²©, ì–‘ì„±/ìŒì„±, ë³µê·€/ì´íƒˆ ë“±

### ğŸ“ì´ì»¤ë¨¸ìŠ¤Â ê³ ê°ì˜ ì´íƒˆê°€ëŠ¥ì„± ì˜ˆì¸¡

1. ì¢…ì†ë³€ìˆ˜: ìµœê·¼ 1ë‹¬ ì´ë‚´ ë³µê·€ ì—¬ë¶€(ë³µê·€: 1 / ì´íƒˆ: 0)
2. ë…ë¦½ë³€ìˆ˜: RFM(íŠ¸ë ˆì¸ ê¸°ê°„ ë‚´ ë§ˆì§€ë§‰ ì£¼ë¬¸ì¼ë¡œë¶€í„° ê²½ê³¼ ì¼ìˆ˜ / ì´ ì£¼ë¬¸ìˆ˜ / í‰ê·  ì£¼ë¬¸ê¸ˆì•¡)
3. ì¸¡ì •ì¸ì›: 1ì²œëª…
4. ë¶„ì„ë°©ë²•: RFM ì ìˆ˜ ì‚°ì¶œí•˜ì—¬ ì´ 5ê·¸ë£¹ìœ¼ë¡œ ê³ ê° ë¶„ë¥˜
        
    - ê°ê°ì˜ ë…ë¦½ë³€ìˆ˜ë¥¼ **ë°±ë¶„ìœ„ìˆ˜ ê°œë… í™œìš©í•´ì„œ 1~4ì ìœ¼ë¡œ í™˜ì‚°**
    - Total score = í™˜ì‚°í•œ ì ìˆ˜ *** íšŒê·€ê³„ìˆ˜** ë“¤ì˜ ì´í•©
        - monetary scoreëŠ” íšŒê·€ê³„ìˆ˜ ê³±í–ˆì„ ë•Œ ê±°ì˜ 0ì ì— ê°€ê¹Œì›€ = ì¢…ì†ë³€ìˆ˜ì™€ ìƒê´€ì„±ì´ êµ‰ì¥íˆ ë‚®ìŒ
        - 1~4 í™˜ì‚°ì ìˆ˜ë§Œ ê·¸ëŒ€ë¡œ ì“°ë©´ ì˜í–¥ë ¥ ì—†ëŠ” monetaryë„ ê·¸ëŒ€ë¡œ ë°˜ì˜ë¼ì„œ ì˜ˆì¸¡ ëª¨ë¸ì˜ ì •í™•ë„ ë–¨ì–´ì§
5. ê¸°ì¤€ ê¸°ê°„
    
    ```sql
             íŠ¸ë ˆì¸ ê¸°ê°„             ì˜ˆì¸¡ ê¸°ê°„
    60ì¼ ì „ ------------- 30ì¼ ì „ ------------ í˜„ì¬
            RFM ì ìˆ˜ ì‚°ì¶œ           ì´íƒˆì—¬ë¶€ í™•ì¸
    ```
    
6. python ì½”ë“œ

```python
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

import sklearn
from sklearn.linear_model import LogisticRegression
from sklearn.model_selection import train_test_split

df = pd.read_csv('https://raw.githubusercontent.com/min1112/Data_Analysis_Skill_Exercise/refs/heads/main/Part2.ch03_RFM/rfm_mart.csv')

df
df.info()
```

| mem_no | last_ord_dt | recency | frequency | monetary | is_back |
|--------|------------|---------|-----------|----------|---------|
| 1      | 2023-01-01 | 30      | 1         | 28700    | 0       |
| 2      | 2023-01-12 | 19      | 7         | 26929    | 0       |
| 3      | 2023-01-01 | 30      | 1         | 54800    | 0       |
| 4      | 2023-01-27 | 4       | 3         | 25700    | 0       |
| 5      | 2023-01-30 | 1       | 2         | 6500     | 0       |
| ...    | ...        | ...     | ...       | ...      | ...     |
| 996    | 2023-01-02 | 29      | 3         | 31000    | 1       |
| 997    | 2023-01-30 | 1       | 2         | 16450    | 1       |
| 998    | 2023-01-01 | 30      | 1         | 13600    | 0       |
| 999    | 2023-01-01 | 30      | 1         | 14200    | 1       |
| 1000   | 2023-01-27 | 4       | 2         | 24250    | 0       |



```python
# ë¡œì§€ìŠ¤í‹± íšŒê·€ê³„ìˆ˜ êµ¬í•˜ê¸°
x = df.drop(['mem_no','last_ord_dt','is_back'], axis=1)
y = df['is_back']

x_train, x_test, y_train, y_test = sklearn.model_selection.train_test_split(x, y)

model = LogisticRegression()
model.fit(x_train, y_train)

# test dataë¡œ ëª¨ë¸ì˜ ì˜ˆì¸¡ë„ í™•ì¸
model.score(x_test, y_test)  #0.712 ë‚®ì€ ê±´ ì•„ë‹ˆì§€ë§Œ ì‹¤ë¬´ì—ì„  80 ì´ìƒ ë§Œë“¤ê¸° ìœ„í•´ ë…ë¦½ë³€ìˆ˜ë¥¼ ë„£ê³  ë¹¼ê³  ì—°êµ¬

coef = pd.DataFrame({'features': x.columns, 'coefficient':model.coef_[0]})
coef
```

| features | coefficienc |
| --- | --- |
| recency | -0.060135 |
| frequency | 0.082922 |
| monetary | -0.000001 |

```python
# ë°±ë¶„ìœ„ìˆ˜(Percencile) ê¸°ë°˜ìœ¼ë¡œ RFM ì ìˆ˜ ì‚°ì¶œí•˜ê¸°
a1, a2, a3 = np.percentile(df['recency'],[20,40,60])
a1, a2, a3

def percent(x):
  if x <= a1:
    return 4
  elif x > a1 and x <= a2:
    return 3
  elif x > a2 and x < a3:
    return 2
  elif x >= a3:
    return 1
    
df['recency_score'] = df['recency'].apply(percent)*-coef.iloc[0,1]

# frequency, monetary scoreë„ ìœ„ì™€ ê°™ì´ ë§Œë“¤ì–´ì¤Œ

df['total_score'] = df['recency_score'] + df['frequency_score'] + df['monetary_score']
df
```
| mem_no | last_ord_dt | recency | frequency | monetary | is_back | recency_score | frequency_score | monetary_score | total_score |
|--------|------------|---------|-----------|----------|---------|---------------|----------------|----------------|-------------|
| 1      | 2023-01-01 | 30      | 1         | 28700    | 0       | 0.060135      | 0.082922       | 0.000004       | 0.143061    |
| 2      | 2023-01-12 | 19      | 7         | 26929    | 0       | 0.180405      | 0.331687       | 0.000003       | 0.512095    |
| 3      | 2023-01-01 | 30      | 1         | 54800    | 0       | 0.060135      | 0.082922       | 0.000004       | 0.143061    |
| 4      | 2023-01-27 | 4       | 3         | 25700    | 1       | 0.240540      | 0.248765       | 0.000003       | 0.489308    |
| 5      | 2023-01-30 | 1       | 2         | 6500     | 0       | 0.060135      | 0.165843       | 0.000001       | 0.225979    |
| ...    | ...        | ...     | ...       | ...      | ...     | ...           | ...            | ...            | ...         |
| 996    | 2023-01-02 | 29      | 3         | 31000    | 1       | 0.120270      | 0.248765       | 0.000004       | 0.369039    |
| 997    | 2023-01-30 | 1       | 2         | 16450    | 1       | 0.240540      | 0.165843       | 0.000003       | 0.406384    |
| 998    | 2023-01-01 | 30      | 1         | 13600    | 0       | 0.060135      | 0.082922       | 0.000002       | 0.143058    |
| 999    | 2023-01-01 | 30      | 1         | 14200    | 1       | 0.060135      | 0.082922       | 0.000002       | 0.143058    |
| 1000   | 2023-01-27 | 4       | 2         | 24250    | 0       | 0.240540      | 0.165843       | 0.000003       | 0.406386    |



```python
# total_score ê¸°ì¤€ 5ê·¸ë£¹ ë¶„ë¥˜
t1, t2, t3, t4 = np.percentile(df['total_score'],[20,50,70,90])
t1, t2, t3, t4

def level(x):
  if x <= t1:
    return 5
  elif x > t1 and x <= t2:
    return 4
  elif x > t2 and x <= t3:
    return 3
  elif x > t3 and x <= t4:
    return 2
  elif x > t4:
    return 1

df['level'] = df['total_score'].apply(level)

df.level.value_counts()
```

| level | count |
| --- | --- |
| 5 | 274 |
| 4 | 228 |
| 3 | 214 |
| 2 | 185 |
| 1 | 99 |

```python
# 5ê·¸ë£¹ë³„ë¡œ ë¦¬í…ì…˜(1-ë¦¬í…ì…˜) êµ¬í•˜ê¸°
pivot = df.groupby('level').agg({'is_back':'sum','mem_no':'count'})
pivot['retention'] = pivot.is_back/pivot.mem_no

pivot
```

| **level** | is_back | mem_no | retention |
| --- | --- | --- | --- |
| **1** | 88 | 99 | 0.888889 |
| **2** | 90 | 185 | 0.486486 |
| **3** | 107 | 214 | 0.500000 |
| **4** | 59 | 228 | 0.258772 |
| **5** | 74 | 274 | 0.270073 |