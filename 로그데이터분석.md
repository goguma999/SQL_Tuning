# [DA] ë¡œê·¸ë°ì´í„° ë¶„ì„

ì¶œë°œ~: 2025/03/07
íŒŒíŠ¸: DA

### ğŸ“ë¡œê·¸ë°ì´í„°Â ?

- ê³ ê°ì´ ì„œë¹„ìŠ¤ì— ìœ ì…ë˜ì–´ ë‚¨ê¸°ëŠ” í–‰ë™ ë°ì´í„°
- ìœ ì…, í˜ì´ì§€ ì´ë™, ë…¸ì¶œ, í´ë¦­ ë“± ë°ì´í„°ê°€ ì´ë²¤íŠ¸ ë‹¨ìœ„ë¡œ ì ì¬ë¨
- í…Œì´ë¸”ì´ ë¬´ê±°ìš´ í¸ì´ê³ , ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì™„ë²½í•œ ì´í•´ê°€ ì—†ë‹¤ë©´ ë°ì´í„° í™œìš©ì´ ì–´ë ¤ì›€
- ex
    - ì„œë¹„ìŠ¤/í”„ë¡œë•íŠ¸ ê°œì„ 
    - ê³ ê° í–‰ë™ ê¸°ë°˜ ë°ì´í„° ë¶„ì„

### ğŸ“ì–´ë–¤Â ë°°ë„ˆë¥¼ í†µí•´ ìœ ì…ëœ ê³ ê°ì˜ ì£¼ë¬¸ ì „í™˜ìœ¨ì´ ë” ë†’ì„ê¹Œ ?

1. ì¢…ì†ë³€ìˆ˜ : ì£¼ë¬¸ì „í™˜ ì—¬ë¶€(1: ë°°ë„ˆë¥¼ í†µí•´ ìœ ì…ëœ í›„ ì£¼ë¬¸ì„ í–ˆì„ ê²½ìš° / 0: ë°°ë„ˆë¥¼ í†µí•œ ì£¼ë¬¸ì´ ì—†ëŠ” ê²½ìš°)
2. ë…ë¦½ë³€ìˆ˜ : ë°°ë„ˆ ìœ í˜•(bnr1 / bnr2)
3. ì¸¡ì •ì¸ì› : 40ëª…
4. `log_table`
    
    ![bnr1 = bnr1ì„ í´ë¦­í•´ì„œ ìœ ì…ë¨](%5BDA%5D%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%20%E1%84%87%E1%85%AE%E1%86%AB%E1%84%89%E1%85%A5%E1%86%A8%201af9dc3843b580438435f9bd07e6091f/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-03-07_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_9.53.00.png)
    
    bnr1 = bnr1ì„ í´ë¦­í•´ì„œ ìœ ì…ë¨
    
    `order_master_log`
    
    ![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-03-07 á„‹á…©á„’á…® 9.55.42.png](%5BDA%5D%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%20%E1%84%87%E1%85%AE%E1%86%AB%E1%84%89%E1%85%A5%E1%86%A8%201af9dc3843b580438435f9bd07e6091f/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-03-07_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_9.55.42.png)
    
5. sql ë¶„ì„
    
    ```sql
    with log as (
    	select distinct mem_no
    		, session_id
    		, log_dt
    		, CAST(log_stamp AS DATETIME)  as log_stamp
    		, min(referrer) over (partition by mem_no order by log_stamp) as bnr_type
    			# bnr_typeì—ëŠ” bnr1/2 ì´ê±°ë‚˜ null ê°’ -> bnr1/2 ê°’ë§Œ ê°€ì ¸ì˜¤ê¸° 
    	from log_table
    )
    ```
    
    ![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-03-07 á„‹á…©á„’á…® 10.29.59.png](%5BDA%5D%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%20%E1%84%87%E1%85%AE%E1%86%AB%E1%84%89%E1%85%A5%E1%86%A8%201af9dc3843b580438435f9bd07e6091f/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-03-07_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_10.29.59.png)
    
    ```sql
    , ord as (
    	select distinct a.mem_no
    			, log_dt
    			, log_stamp
    			, bnr_type
    			, CAST(ord_stamp as DATETIME) as ord_stamp
    			, count(distinct ord_no) as ord_cnt
    		from log a 
    		left join order_master_log b 
    			on a.mem_no = b.mem_no
    			and log_dt = str_to_date(ord_stamp,'%Y-%m-%d') 
    			#omlì—ëŠ” order_noê°€ ì—†ë‹¤ë©´, ë¡œê·¸ìŠ¤íƒ¬í”„ì™€ ì˜¤ë”ìŠ¤íƒ¬í”„ë¥¼ í™œìš©í•´ ì¡°ì¸ 
    			#omlì—ëŠ” ì‹œë¶„ì´ˆ í¬í•¨ stamp ë¡œê·¸ë§Œ ìˆì–´ì„œ 'YYYY-mm-dd'í˜•ìœ¼ë¡œ ë°”ê¿ˆ 
    			and log_stamp < CAST(ord_stamp as DATETIME) 
    			-- and a.session_id = b.session_id
    		group by 1,2,3,4,5
    )
    ```
    
    ![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-03-07 á„‹á…©á„’á…® 11.06.28.png](%5BDA%5D%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%20%E1%84%87%E1%85%AE%E1%86%AB%E1%84%89%E1%85%A5%E1%86%A8%201af9dc3843b580438435f9bd07e6091f/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-03-07_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_11.06.28.png)
    
    ```sql
    , ord2 as (
    	select distinct mem_no
    			, bnr_type
    			, case when ord_cnt >= 1 then 1 else 0 end as is_ord
    			# í•œ ë©¤ë²„ê°€ 2ê±´ ì´ìƒ ì£¼ë¬¸í–ˆì–´ë„ 1=ì£¼ë¬¸í•¨ ìœ¼ë¡œ ë°”ê¿ˆ 
    	from ord
    )
    
    select bnr_type
    	, sum(is_ord) as ord_cnt
    from ord2
    group by 1 ;
    ```
    
    ![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-03-07 á„‹á…©á„’á…® 11.09.14.png](%5BDA%5D%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%83%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A5%20%E1%84%87%E1%85%AE%E1%86%AB%E1%84%89%E1%85%A5%E1%86%A8%201af9dc3843b580438435f9bd07e6091f/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-03-07_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_11.09.14.png)
    
    â†’ ê°ê°ì˜ ìƒ˜í”Œ ì‚¬ì´ì¦ˆê°€ ê°™ê³ , bnr2ê°€ bnr1ë³´ë‹¤ 4ë°° ë” í° ì£¼ë¬¸ë¥ . (ë‹¤ë§Œ ì‘ì€ ìƒ˜í”Œ ë°ì´í„°ì´ê¸° ë•Œë¬¸ì— ìœ ì˜ë¯¸í•œ ì°¨ì´ë¼ê³  ë§í•˜ê¸° ì–´ë ¤ì›€.)